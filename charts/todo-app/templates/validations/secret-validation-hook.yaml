{{- if .Values.validations.secrets.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "todo-app.fullname" . }}-secret-validation
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "todo-app.standard-labels" . | nindent 4 }}
    app.kubernetes.io/component: validation
data:
  validate-secrets.sh: |
    #!/bin/bash
    echo "Validating required secrets before installation..."

    # Check if required secrets exist
    secrets_to_check=(
      "{{ include "todo-app.fullname" . }}-auth-secret"
      "{{ include "todo-app.fullname" . }}-db-secret"
    )

    {{- if .Values.ai.coapiKey }}
    secrets_to_check+=("{{ include "todo-app.fullname" . }}-ai-secret")
    {{- end }}

    for secret in "${secrets_to_check[@]}"; do
      if ! kubectl get secret "$secret" -n {{ .Release.Namespace }} >/dev/null 2>&1; then
        echo "ERROR: Secret $secret does not exist in namespace {{ .Release.Namespace }}"
        echo "Please create the required secrets before installing the chart"
        exit 1
      fi
      echo "âœ“ Secret $secret exists"
    done

    echo "All required secrets are present!"
{{- end }}